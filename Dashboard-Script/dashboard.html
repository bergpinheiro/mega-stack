<script>
(function () {
  /* === CONFIG: usa el label tal como aparece en TU sidebar === */
  const CFG = {
    LINK_TEXT: 'Mi Aplicaci√≥n',
    LINK_ICON: 'üß≠',
    IFRAME_URL: 'https://tu-app-embebible.example.com', // ‚Üê usa una URL que permita iframe
    POSITION: { mode: 'afterLabel', label: 'Conversaciones', index: 0 }, // o 'Conversations' si tu UI est√° en ingl√©s
    IFRAME_SANDBOX: 'allow-forms allow-modals allow-popups allow-popups-to-escape-sandbox allow-same-origin allow-scripts',
    IFRAME_ALLOW:   'clipboard-read; clipboard-write; geolocation; microphone; camera; fullscreen'
  };

  const $ = (s, r=document) => { try { return r.querySelector(s); } catch { return null; } };
  const $$ = (s, r=document) => { try { return Array.from(r.querySelectorAll(s)); } catch { return []; } };
  const on = (el, ev, fn, opts) => el && el.addEventListener(ev, fn, opts || { passive: true });
  const normalize = s => (s || '').toLowerCase().replace(/\s+/g, ' ').trim();

  /* Sidebar */
  function findSidebar() { return $('[data-testid="sidebar-primary"]') || $('aside'); }

  /* PANEL: fijo a la derecha del sidebar, no tapa el sidebar */
  function ensurePanel() {
    if ($('#cw-embed-panel')) return $('#cw-embed-panel');

    const panel = document.createElement('div');
    panel.id = 'cw-embed-panel';
    // cuando est√° oculto no recibe clicks; cuando visible, solo ocupa a la derecha del sidebar
    panel.style.cssText = 'position:fixed; inset:auto 0 0 0; top:0; z-index:9; display:none;';
    panel.innerHTML = `
      <iframe id="cw-embed-iframe" style="width:100%;height:100%;border:0;display:block;"
        ${CFG.IFRAME_SANDBOX ? `sandbox="${CFG.IFRAME_SANDBOX}"` : ''}
        ${CFG.IFRAME_ALLOW ? `allow="${CFG.IFRAME_ALLOW}"` : ''}
        referrerpolicy="no-referrer"></iframe>
    `;
    document.body.appendChild(panel);

    function layout() {
      const sb = findSidebar(); if (!sb) return;
      const r = sb.getBoundingClientRect();
      panel.style.left = r.right + 'px';
      panel.style.width = Math.max(0, window.innerWidth - r.right) + 'px';
      panel.style.background = getComputedStyle(document.body).backgroundColor; // respeta modo claro/oscuro
    }
    layout();
    on(window, 'resize', layout);

    /* Handlers globales */
    window.__cwShowEmbedPanel = () => {
      const iframe = $('#cw-embed-iframe');
      if (iframe) iframe.src = CFG.IFRAME_URL;
      layout();
      panel.style.display = 'block';
    };
    window.__cwHideEmbedPanel = () => {
      panel.style.display = 'none';
      const iframe = $('#cw-embed-iframe');
      if (iframe) iframe.src = 'about:blank';
    };

    /* üîí AUTO-CIERRE PARA EVITAR ‚ÄúBLOQUEO‚Äù AL NAVEGAR */
    // 1) Clic en cualquier link del SIDEBAR ‚Üí cerrar panel
    const sb = findSidebar();
    if (sb) {
      on(sb, 'click', (e) => {
        const a = e.target && e.target.closest ? e.target.closest('a[href]') : null;
        if (a) { window.__cwHideEmbedPanel && window.__cwHideEmbedPanel(); }
      });
    }
    // 2) Cambios de ruta SPA ‚Üí cerrar panel
    const _pushState = history.pushState;
    const _replaceState = history.replaceState;
    history.pushState = function () { window.__cwHideEmbedPanel && window.__cwHideEmbedPanel(); return _pushState.apply(this, arguments); };
    history.replaceState = function () { window.__cwHideEmbedPanel && window.__cwHideEmbedPanel(); return _replaceState.apply(this, arguments); };
    on(window, 'popstate', () => window.__cwHideEmbedPanel && window.__cwHideEmbedPanel());
    // 3) Tecla Esc ‚Üí cerrar
    on(window, 'keydown', (e) => { if (e.key === 'Escape') window.__cwHideEmbedPanel && window.__cwHideEmbedPanel(); });

    return panel;
  }

  /* Busca en TODO el sidebar el <ul> y el <li> cuyo texto coincida con label */
  function findListAndRefByLabel(labelWanted) {
    const sb = findSidebar(); if (!sb) return { list: null, ref: null };
    const wanted = normalize(labelWanted);
    const uls = $$('ul', sb);
    for (const ul of uls) {
      const lis = $$(':scope > li', ul);
      for (const li of lis) {
        const txt = normalize(li.textContent);
        if (txt === wanted || txt.includes(wanted)) { return { list: ul, ref: li }; }
      }
    }
    return { list: null, ref: null };
  }

  function findAnyList() { const sb = findSidebar(); return sb ? $('ul', sb) : null; }

  /* Inserta el link en el sidebar con posici√≥n controlada */
  function ensureSidebarLink() {
    if ($('#cw-embed-link')) return;

    const li = document.createElement('li');
    li.id = 'cw-embed-link';
    li.style.listStyle = 'none';
    li.innerHTML = `
      <a href="javascript:void(0)" style="display:flex;align-items:center;gap:10px;
        padding:8px 12px;border-radius:8px;text-decoration:none;color:inherit;">
        <span>${CFG.LINK_ICON}</span><span>${CFG.LINK_TEXT}</span>
      </a>`;
    const link = li.querySelector('a');

    let parentList = null, ref = null;
    if (CFG.POSITION.mode === 'afterLabel' || CFG.POSITION.mode === 'beforeLabel') {
      const found = findListAndRefByLabel(CFG.POSITION.label);
      parentList = found.list; ref = found.ref;
    }
    if (!parentList) parentList = findAnyList();
    if (!parentList) return;

    const items = $$(':scope > li', parentList);
    switch (CFG.POSITION.mode) {
      case 'start':
        parentList.insertBefore(li, items[0] || null);
        break;
      case 'index':
        parentList.insertBefore(li, items[Math.max(0, Math.min(CFG.POSITION.index, items.length))] || null);
        break;
      case 'afterLabel':
        if (ref && ref.nextSibling) parentList.insertBefore(li, ref.nextSibling);
        else parentList.appendChild(li);
        break;
      case 'beforeLabel':
        if (ref) parentList.insertBefore(li, ref);
        else parentList.insertBefore(li, items[0] || null);
        break;
      case 'end':
      default:
        parentList.appendChild(li);
    }

    // Abrir panel al click (sin preventDefault)
    on(link, 'click', () => { window.__cwShowEmbedPanel && window.__cwShowEmbedPanel(); });
  }

  function boot() { ensurePanel(); ensureSidebarLink(); }
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', boot); else boot();
  new MutationObserver(() => ensureSidebarLink()).observe(document.body, { childList: true, subtree: true });
})();
</script>
